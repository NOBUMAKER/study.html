<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Study Log Pro</title>
  <link rel="manifest" href="manifest.json" />
  <link rel="stylesheet" href="style.css" />
</head>

<body>
  <header class="topbar">
    <div class="brand">
      <div class="logo">Study Log</div>
      <div class="sub">USCPA Planner</div>
    </div>

    <div class="headerRight">
      <div class="pill" id="examCountdown">Exam: —</div>
      <button class="iconBtn" id="btnSettings" title="Settings" type="button">⚙︎</button>
    </div>
  </header>

  <main class="shell">
    <aside class="sidebar">
      <button class="nav active" id="tabDaily" type="button" onclick="show('daily')">Today</button>
      <button class="nav" id="tabWeekly" type="button" onclick="show('weekly')">Week</button>
      <button class="nav" id="tabMaster" type="button" onclick="show('master')">Master</button>
      <button class="nav" id="tabCalendar" type="button" onclick="show('calendar')">Calendar</button>
      <button class="nav" id="tabHistory" type="button" onclick="show('history')">History</button>
    </aside>

    <section class="content">

      <!-- ===== DAILY ===== -->
      <section id="daily" class="view">
        <div class="row between">
          <div>
            <div class="h1" id="dailyDate">—</div>
            <div class="muted" id="dailyMeta">—</div>
          </div>
          <div class="row gap8">
            <button class="btn ghost" type="button" onclick="shiftDay(-1)">◀</button>
            <button class="btn ghost" type="button" onclick="goToday()">Today</button>
            <button class="btn ghost" type="button" onclick="shiftDay(1)">▶</button>
          </div>
        </div>

        <div class="grid2">
          <div class="card">
            <div class="cardTop between">
              <div>
                <div class="h2">今日（今週から来たタスク）</div>
                <div class="muted">Weekで「今週→今日以降へ振り分け」を押すとここに来ます</div>
              </div>
            </div>
            <ul id="dailyAutoList" class="list"></ul>
          </div>

          <div class="card">
            <div class="cardTop between">
              <div>
                <div class="h2">今日（手動タスク）</div>
                <div class="muted">思いついた作業・急ぎタスク</div>
              </div>
              <button class="btn primary" type="button" onclick="addManualTask()">＋追加</button>
            </div>

            <ul id="dailyManualList" class="list"></ul>

            <div class="divider"></div>

            <div class="row between">
              <div>
                <div class="h2">学習時間（手動）</div>
                <div class="muted">分数を入力して加算</div>
              </div>
              <button class="btn ghost danger" type="button" onclick="resetDayMinutes()">0にする</button>
            </div>

            <div class="row gap8">
              <input class="input" id="minsInput" inputmode="numeric" placeholder="例: 90" />
              <button class="btn" type="button" onclick="addMinutes()">加算</button>
              <div class="pill" id="todayMinutes">学習時間 —</div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="cardTop between">
            <div>
              <div class="h2">復習のタイミング（提案）</div>
              <div class="muted">講義/演習を完了すると、1/3/7/14日後の復習候補が出ます（回数も表示）</div>
            </div>
            <div class="pill" id="reviewHint">—</div>
          </div>
          <ul id="todayReviewList" class="list compact"></ul>
        </div>
      </section>

      <!-- ===== WEEKLY ===== -->
      <section id="weekly" class="view" hidden>
        <div class="row between">
          <div>
            <div class="h1" id="weekLabel">—</div>
            <div class="muted" id="weekMeta">—</div>
          </div>
          <div class="row gap8">
            <button class="btn ghost" type="button" onclick="shiftWeek(-1)">◀</button>
            <button class="btn ghost" type="button" onclick="goThisWeek()">This week</button>
            <button class="btn ghost" type="button" onclick="shiftWeek(1)">▶</button>
          </div>
        </div>

        <div class="grid2">
          <div class="card">
            <div class="cardTop between">
              <div>
                <div class="h2">今週タスク</div>
                <div class="muted">Masterから積む → まとめて今日以降に振り分け</div>
              </div>
            </div>

            <!-- 操作はJSがこの中にボタンを差し込みます（weeklyAutoBoard） -->
            <div id="weeklyAutoBoard" class="board"></div>
          </div>

          <div class="card">
            <div class="cardTop between">
              <div>
                <div class="h2">設定 / 容量</div>
                <div class="muted">週の容量（分）や試験日、復習間隔</div>
              </div>
              <button class="btn" type="button" onclick="openSettings()">設定</button>
            </div>

            <div class="kpi">
              <div class="kpiItem">
                <div class="label">週の容量</div>
                <div class="value" id="weeklyCap">—</div>
              </div>
              <div class="kpiItem">
                <div class="label">未完了の推定</div>
                <div class="value" id="weeklyAssigned">—</div>
              </div>
              <div class="kpiItem">
                <div class="label">余り</div>
                <div class="value" id="weeklyRemain">—</div>
              </div>
            </div>

            <div class="divider"></div>
            <div class="muted">※ 自動割り当ては使いません（あなたの運用に合わせてシンプルに）。</div>

            <div class="row gap8" style="margin-top:10px; flex-wrap:wrap;">
              <button class="btn ghost danger" type="button" onclick="wipeAll()">全データ削除</button>
            </div>
          </div>
        </div>
      </section>

      <!-- ===== MASTER ===== -->
      <section id="master" class="view" hidden>
        <div class="row between">
          <div>
            <div class="h1">Master</div>
            <div class="muted">全タスクの母体（チェックして今週に積めます）</div>
          </div>
          <div class="row gap8">
            <button class="btn primary" type="button" onclick="addMasterTask()">＋Master追加</button>
            <button class="btn" type="button" onclick="openWeeklyPickMaster()">選択 → 今週へ追加</button>
          </div>
        </div>

        <div class="card">
          <div class="row gap8">
            <input class="input" id="masterSearch" placeholder="検索（例: FAR / AUD / Becker）" oninput="render()" />
            <select class="select" id="masterFilter" onchange="render()">
              <option value="all">すべて</option>
              <option value="open">未完了</option>
              <option value="done">完了</option>
            </select>
          </div>

          <ul id="masterList" class="list"></ul>
        </div>
      </section>

      <!-- ===== CALENDAR ===== -->
      <section id="calendar" class="view" hidden>
        <div class="row between">
          <div>
            <div class="h1" id="calMonthLabel">—</div>
            <div class="muted">色は「その日の達成率（完了割合）」</div>
          </div>
          <div class="row gap8">
            <button class="btn ghost" type="button" onclick="shiftMonth(-1)">◀</button>
            <button class="btn ghost" type="button" onclick="goThisMonth()">This month</button>
            <button class="btn ghost" type="button" onclick="shiftMonth(1)">▶</button>
          </div>
        </div>

        <!-- ★カレンダーが出ない対策：必ず描画領域を確保 -->
        <div class="card">
          <div id="calendarGrid" class="calendar"></div>
        </div>
      </section>

      <!-- ===== HISTORY ===== -->
      <section id="history" class="view" hidden>
        <div class="row between">
          <div>
            <div class="h1">History</div>
            <div class="muted">過去の週・日</div>
          </div>
        </div>

        <div class="grid2">
          <div class="card">
            <div class="h2">週</div>
            <ul id="historyWeeks" class="list compact"></ul>
          </div>

          <div class="card">
            <div class="h2">日（直近14日）</div>
            <ul id="historyDays" class="list compact"></ul>
          </div>
        </div>
      </section>

    </section>
  </main>

  <!-- ===== SETTINGS MODAL ===== -->
  <div class="modal" id="settingsModal" hidden>
    <div class="modalCard">
      <div class="row between">
        <div>
          <div class="h2">Settings</div>
          <div class="muted">試験日・週の容量・復習間隔</div>
        </div>
        <button class="iconBtn" type="button" onclick="closeSettings()">✕</button>
      </div>

      <div class="form">
        <label class="field">
          <span>試験日</span>
          <input class="input" id="examDateInput" type="date" />
        </label>

        <label class="field">
          <span>週の容量（分）</span>
          <input class="input" id="weeklyCapInput" inputmode="numeric" placeholder="例: 900（=15時間）" />
        </label>

        <label class="field">
          <span>復習オフセット（日）</span>
          <input class="input" id="reviewOffsetsInput" placeholder="例: 1,3,7,14" />
        </label>

        <div class="row gap8">
          <button class="btn primary" type="button" onclick="saveSettings()">保存</button>
          <button class="btn ghost" type="button" onclick="closeSettings()">閉じる</button>
        </div>
      </div>
    </div>
  </div>

  <script src="app.js"></script>
</body>
</html>
